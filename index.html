<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Calorie Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ2Fsb3JpZSBUcmFja2VyIiwic2hvcnRfbmFtZSI6IkNhbFRyYWNrIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiMyNTYzZWIifQ==" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
  <style>
    :root{--bg:#fff;--text:#111;--card:#f6f8fa;--accent:#2563eb}
    @media (prefers-color-scheme:dark){:root{--bg:#0d1117;--text:#e6edf3;--card:#161b22;--accent:#58a6ff}}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{padding:1rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
    h1{margin:0;font-size:1.5rem}
    button{background:var(--accent);color:#fff;border:none;padding:.5rem 1rem;border-radius:.25rem;cursor:pointer}
    input,select{width:100%;padding:.5rem;margin:.25rem 0;border:1px solid #888;border-radius:.25rem;background:var(--card);color:var(--text)}
    .card{background:var(--card);padding:1rem;margin:1rem 0;border-radius:.5rem;box-sizing:border-box;}
    .row{display:flex;gap:1rem;flex-wrap:wrap}
    .col{flex:1 1 280px;min-width:260px;box-sizing:border-box;}
    table{width:100%;border-collapse:collapse;overflow-x:auto;display:block;}
    th,td{padding:.5rem;text-align:left}
    .hidden{display:none}
    @media (max-width: 900px) {
      .row { flex-direction: column; gap:0; }
      .col { min-width:0; margin-bottom:1rem; }
      header { flex-direction: column; align-items: flex-start; gap:.5rem; }
    }
    @media (max-width: 600px) {
      body { font-size: 1rem; }
      .card { padding:.75rem; margin:.5rem 0; }
      h1 { font-size:1.2rem; }
      h2 { font-size:1rem; }
      table, thead, tbody, th, td, tr { font-size:.95rem; }
      .row { gap:0; }
      .col { padding:0; }
      header { padding:.75rem; }
    }
    @media (max-width: 400px) {
      .card { padding:.5rem; }
      button, input, select { font-size:.95rem; }
      th,td { padding:.3rem; }
    }
  </style>
</head>
<body>
<header>
  <h1>Calorie Tracker</h1>
  <button id="installBtn" class="hidden">Install</button>
</header>

<main class="row">
  <section class="col card">
    <h2>Dashboard</h2>
    <canvas id="dayChart" height="120"></canvas>
    <canvas id="weekChart" height="120"></canvas>
  </section>

  <section class="col card">
    <h2>Goals</h2>
    <input id="goalCal" type="number" placeholder="Calories" min="0" />
    <input id="goalPro" type="number" placeholder="Protein g" min="0" />
    <input id="goalCarb" type="number" placeholder="Carbs g" min="0" />
    <input id="goalFat" type="number" placeholder="Fat g" min="0" />
    <button id="saveGoal">Save Goals</button>
  </section>

  <section class="col card">
    <h2>Add Meal</h2>
    <input id="searchFood" placeholder="Type to search food…" autocomplete="off" />
    <select id="foodPick"></select>
    <input id="qty" type="number" placeholder="Quantity (g)" value="100" min="1" />
    <button id="addMeal">Add</button>
  </section>

  <section class="col card">
    <h2>Today <span id="todayDate"></span></h2>
    <table id="mealTable">
      <thead><tr><th>Food</th><th>Qty</th><th>Cal</th><th>P</th><th>C</th><th>F</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <p id="totals"><strong>Totals:</strong> <span id="tCal">0</span> kcal | P <span id="tPro">0</span> | C <span id="tCarb">0</span> | F <span id="tFat">0</span></p>
  </section>
</main>

<script>
/* ---------- config ---------- */
const CONFIG = { USDA_KEY: "Haax6z6qr1xjcVRAjPC7Y1jMGchRRCbXCoyPnTSZ" };   

/* ---------- mini fallback DB ---------- */
const FOODS = [
{id:1,name:"Egg, boiled",cal:155,pro:13,carb:1.1,fat:11},
{id:2,name:"Bread, toast",cal:313,pro:13,carb:56,fat:4},
{id:3,name:"Chicken breast, grilled",cal:165,pro:31,carb:0,fat:3.6},
{id:4,name:"Rice, white, cooked",cal:130,pro:2.7,carb:28,fat:0.3},
{id:5,name:"Apple",cal:52,pro:.3,carb:14,fat:.2},
{id:6,name:"Banana",cal:89,pro:1.1,carb:23,fat:.3},
{id:7,name:"Milk, 2%",cal:50,pro:3.3,carb:5,fat:2},
{id:8,name:"Potato, boiled",cal:87,pro:2,carb:20,fat:.1},
{id:9,name:"Broccoli, boiled",cal:35,pro:2.4,carb:7,fat:.4},
{id:10,name:"Salmon, baked",cal:206,pro:22,carb:0,fat:13}
];

/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
const storage = {
  get(k) { return JSON.parse(localStorage.getItem(k) || "null") },
  set(k, v) { localStorage.setItem(k, JSON.stringify(v)) }
};
const todayStr = () => new Date().toISOString().slice(0, 10);

/* ---------- state ---------- */
let meals = storage.get("meals") || [];
let goals = storage.get("goals") || { cal: 2000, pro: 150, carb: 250, fat: 65 };

/* ---------- USDA search ---------- */
async function searchUSDA(q) {
  if (!CONFIG.USDA_KEY) return [];
  const url = `https://api.nal.usda.gov/fdc/v1/foods/search?apiKey=${CONFIG.USDA_KEY}&query=${encodeURIComponent(q)}&dataType=Foundation,SR%20Legacy&pageSize=20`;
  try {
    console.log("USDA request:", url);                // ← remove after test
    const res = await fetch(url);
    console.log("USDA response status:", res.status); // ← remove after test
    if (!res.ok) {
      const txt = await res.text();
      console.error("USDA body:", txt);               // ← shows real error
      throw new Error("USDA error " + res.status);
    }
    const data = await res.json();
    return data.foods.map(f => ({
      id: f.fdcId,
      name: f.description,
      cal: (f.foodNutrients.find(n => n.nutrientName === "Energy")?.value || 0),
      pro: (f.foodNutrients.find(n => n.nutrientName === "Protein")?.value || 0),
      carb: (f.foodNutrients.find(n => n.nutrientName === "Carbohydrate, by difference")?.value || 0),
      fat: (f.foodNutrients.find(n => n.nutrientName === "Total lipid (fat)")?.value || 0),
      unit: "g"
    }));
  } catch (e) {
    console.warn("USDA fail", e);                     // keep this line
    return [];
  }
}
/* ---------- goals ---------- */
function loadGoals() {
  if ($("#goalCal")) $("#goalCal").value = goals.cal;
  if ($("#goalPro")) $("#goalPro").value = goals.pro;
  if ($("#goalCarb")) $("#goalCarb").value = goals.carb;
  if ($("#goalFat")) $("#goalFat").value = goals.fat;
}
$("#saveGoal").onclick = () => {
  goals = { cal: +$("#goalCal").value, pro: +$("#goalPro").value, carb: +$("#goalCarb").value, fat: +$("#goalFat").value };
  storage.set("goals", goals);
  renderDash();
};
loadGoals();

/* ---------- food search  (USDA first, fallback local) ---------- */
let currentFoods = FOODS;   // start with offline list
async function updateFoodPick(q) {
  const usda = await searchUSDA(q);
  currentFoods = usda.length ? usda : FOODS.filter(f => f.name.toLowerCase().includes(q.toLowerCase()));
  renderFoodOpts(currentFoods);
}
function renderFoodOpts(list) {
  const pick = $("#foodPick");
  if (!list || list.length === 0) {
    pick.innerHTML = `<option disabled>No foods found</option>`;
  } else {
    pick.innerHTML = list.map(f => `<option value="${f.id}">${f.name}</option>`).join("");
  }
}
$("#searchFood").oninput = (e) => {
  const val = e.target.value || "";
  updateFoodPick(val);
};
// Ensure food dropdown is populated on page load
document.addEventListener("DOMContentLoaded", () => {
  renderFoodOpts(FOODS);
  $("#foodPick").selectedIndex = 0;
  $("#addMeal").onclick = async () => {
    const foodPick = $("#foodPick");
    const qtyInput = $("#qty");
    const qty = +qtyInput.value;
    if (!foodPick.value || foodPick.selectedIndex === -1 || !qty || qty <= 0) return; // Prevent error if nothing is selected or qty invalid
    const id  = +foodPick.value;
    const food = currentFoods.find(f => f.id === id);
    if (!food) return;
    const scale = qty / 100;
    // Ensure all nutrient values are numbers
    const entry = { 
      ...food, 
      cal: Number(food.cal) * scale, 
      pro: Number(food.pro) * scale, 
      carb: Number(food.carb) * scale, 
      fat: Number(food.fat) * scale, 
      qty, 
      date: todayStr(), 
      id: Date.now() 
    };
    meals.push(entry);
    storage.set("meals", meals);
    renderMeals(); renderDash();
  };
});
window.delMeal = function(id) {
  meals = meals.filter(m => m.id !== id);
  storage.set("meals", meals);
  renderMeals(); renderDash();
}
function renderMeals() {
  const tbody = $("#mealTable tbody");
  tbody.innerHTML = "";
  const tday = meals.filter(m => m.date === todayStr());
  let cal = 0, pro = 0, carb = 0, fat = 0;
  tday.forEach(m => {
    cal += m.cal; pro += m.pro; carb += m.carb; fat += m.fat;
    tbody.insertAdjacentHTML("beforeend", `<tr>
      <td>${m.name}</td><td>${m.qty} g</td><td>${m.cal.toFixed(0)}</td><td>${m.pro.toFixed(1)}</td><td>${m.carb.toFixed(1)}</td><td>${m.fat.toFixed(1)}</td>
      <td><button onclick="delMeal(${m.id})">✕</button></td>
    </tr>`);
  });
  $("#tCal").textContent = cal.toFixed(0);
  $("#tPro").textContent = pro.toFixed(1);
  $("#tCarb").textContent = carb.toFixed(1);
  $("#tFat").textContent = fat.toFixed(1);
}
if ($("#todayDate")) $("#todayDate").textContent = todayStr();

/* ---------- charts ---------- */
const dayCanvas = $("#dayChart");
const weekCanvas = $("#weekChart");
const dayCtx = dayCanvas ? dayCanvas.getContext("2d") : null;
const weekCtx = weekCanvas ? weekCanvas.getContext("2d") : null;
let dayChart, weekChart;
function renderDash() {
  const today = meals.filter(m => m.date === todayStr());
  const tCal = today.reduce((s, m) => s + m.cal, 0);
  const tPro = today.reduce((s, m) => s + m.pro, 0);
  const tCarb = today.reduce((s, m) => s + m.carb, 0);
  const tFat = today.reduce((s, m) => s + m.fat, 0);
  const d = { cal: tCal, pro: tPro, carb: tCarb, fat: tFat };
  if (typeof Chart !== "undefined") {
    if (dayChart) dayChart.destroy();
    if (dayCtx) {
      dayChart = new Chart(dayCtx, { type: 'bar', data: {
        labels: ['Calories', 'Protein', 'Carbs', 'Fat'],
        datasets: [
          { label: 'Consumed', data: [d.cal, d.pro, d.carb, d.fat], backgroundColor: '#3b82f6' },
          { label: 'Goal', data: [goals.cal, goals.pro, goals.carb, goals.fat], backgroundColor: '#94a3b8' }
        ]
      }, options: { responsive: true, plugins: { legend: { display: false } } } });
    }
    const days = [...Array(7)].map((_, i) => { const dt = new Date(); dt.setDate(dt.getDate() - i); return dt.toISOString().slice(0, 10); }).reverse();
    const weekData = days.map(d => meals.filter(m => m.date === d).reduce((s, m) => s + m.cal, 0));
    if (weekChart) weekChart.destroy();
    if (weekCtx) {
      weekChart = new Chart(weekCtx, { type: 'line', data: {
        labels: days.map(d => d.slice(5)),
        datasets: [{ label: 'Calories', data: weekData, borderColor: '#3b82f6', fill: false }]
      }, options: { responsive: true, plugins: { legend: { display: false } } } });
    }
  }
}
renderMeals(); renderDash();

/* ---------- PWA ---------- */
let deferredPrompt;
window.addEventListener("beforeinstallprompt", e => { e.preventDefault(); deferredPrompt = e; $("#installBtn").classList.remove("hidden"); });
$("#installBtn").onclick = async () => { if (deferredPrompt) { deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; deferredPrompt = null; $("#installBtn").classList.add("hidden"); } };
</script>

</body>
</html>
