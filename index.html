<script>
/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
const fmt = n => +n.toFixed(1);
const today = new Date().toISOString().slice(0, 10);

/* ---------- state ---------- */
let meals = JSON.parse(localStorage.getItem("meals") || "[]");
let goals = JSON.parse(localStorage.getItem("goals") || '{"cal":2000,"pro":150,"carb":250,"fat":65}');

/* ---------- goals ---------- */
function loadGoals() {
  $("#goalCal").value = goals.cal;
  $("#goalPro").value = goals.pro;
  $("#goalCarb").value = goals.carb;   //  FIXED ID
  $("#goalFat").value = goals.fat;     //  FIXED ID
}
$("#setGoalsBtn").onclick = () => {
  goals = { cal: +$("#goalCal").value, pro: +$("#goalPro").value, carb: +$("#goalCarb").value, fat: +$("#goalFat").value };
  localStorage.setItem("goals", JSON.stringify(goals));
  render();
};

/* ---------- meals ---------- */
$("#addMealBtn").onclick = () => {
  const m = {
    id: Date.now(),
    name: $("#mealName").value.trim(),
    cal: +$("#mealKcal").value,
    pro: +$("#mealPro").value,
    carb: +$("#mealCarb").value,
    fat: $("#mealFat").value,
    date: today
  };
  if (!m.name || !m.cal) return alert("Name & calories required");
  meals.push(m);
  localStorage.setItem("meals", JSON.stringify(meals));
  clearForm(); render();
};
function clearForm() {
  $("#mealName").value = "";
  $("#mealKcal").value = "";
  $("#mealPro").value = "";
  $("#mealCarb").value = "";
  $("#mealFat").value = "";
}
function removeMeal(id) {
  meals = meals.filter(m => m.id !== id);
  localStorage.setItem("meals", JSON.stringify(meals));
  render();
}

/* ---------- render ---------- */
function render() {
  const tbody = $("#mealTable tbody");
  tbody.innerHTML = "";
  let tCal = 0, tPro = 0, tCarb = 0, tFat = 0;
  meals.filter(m => m.date === today).forEach(m => {
    tCal += m.cal; tPro += m.pro; tCarb += m.carb; tFat += Number(m.fat);
    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${m.name}</td><td>${fmt(m.cal)}</td><td>${fmt(m.pro)}</td><td>${fmt(m.carb)}</td><td>${fmt(m.fat)}</td>
        <td><button onclick="removeMeal(${m.id})">âœ•</button></td>
      </tr>`);
  });
  $("#tCal").textContent = fmt(tCal);
  $("#tPro").textContent = fmt(tPro);
  $("#tCarb").textContent = fmt(tCarb);
  $("#tFat").textContent = fmt(tFat);
  $("#todayDate").textContent = today;
}

/* ---------- export / import / reset ---------- */
$("#exportBtn").onclick = () => {
  const blob = new Blob([JSON.stringify({ meals, goals }, null, 2)], { type: "application/json" });
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "calorie-backup.json"; a.click();
};
$("#importBtn").onclick = () => $("#importFile").click();
$("#importFile").onchange = (e) => {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const data = JSON.parse(reader.result);
    meals = data.meals || []; goals = data.goals || goals;
    localStorage.setItem("meals", JSON.stringify(meals)); localStorage.setItem("goals", JSON.stringify(goals));
    render(); alert("Imported");
  };
  reader.readAsText(file);
};
$("#resetBtn").onclick = () => { if (confirm("Delete everything?")) { localStorage.clear(); location.reload(); } };

/* ---------- boot ---------- */
loadGoals(); render();
</script>
